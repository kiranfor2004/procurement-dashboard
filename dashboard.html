
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Procurement Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            margin: 0;
            overflow-x: hidden;
            overflow-y: auto;
        }

        .dashboard-container {
            width: 100%;
            max-width: none;
            margin: 0;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            min-height: calc(100vh - 20px);
        }

        .header {
            background: linear-gradient(45deg, #2c3e50, #3498db);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .header-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .status-inline {
            font-size: 0.9rem;
            font-weight: 600;
            padding: 8px 16px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .status-inline.loading {
            color: #f39c12;
            background: rgba(243, 156, 18, 0.1);
            border-color: rgba(243, 156, 18, 0.3);
        }

        .status-inline.error {
            color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
            border-color: rgba(231, 76, 60, 0.3);
        }

        .status-inline.success {
            color: #27ae60;
            background: rgba(39, 174, 96, 0.1);
            border-color: rgba(39, 174, 96, 0.3);
        }

        .refresh-btn-inline {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .refresh-btn-inline:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .refresh-btn-inline:disabled {
            background: rgba(255, 255, 255, 0.1);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .filters-section {
            background: #ecf0f1;
            padding: 20px;
            border-bottom: 1px solid #bdc3c7;
        }

        .filters-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .filter-group select {
            padding: 8px 12px;
            border: 1px solid #bdc3c7;
            border-radius: 6px;
            background: white;
            font-size: 0.9rem;
            color: #2c3e50;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }

        .filter-group select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
        }

        .filter-actions {
            display: flex;
            gap: 10px;
            align-self: end;
        }

        .filter-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .filter-btn.apply {
            background: #27ae60;
            color: white;
        }

        .filter-btn.apply:hover {
            background: #229954;
        }

        .filter-btn.clear {
            background: #95a5a6;
            color: white;
        }

        .filter-btn.clear:hover {
            background: #7f8c8d;
        }

        .filter-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .active-filters {
            margin-top: 15px;
            padding: 10px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-label {
            font-weight: 600;
            color: #856404;
            font-size: 0.9rem;
        }

        .filter-tags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .filter-tag {
            background: #856404;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .filter-tag .remove {
            cursor: pointer;
            font-weight: bold;
        }

        .filter-tag .remove:hover {
            color: #ffeaa7;
        }

        /* Drill-down Navigation Styles */
        .drill-clickable {
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .drill-clickable:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .drill-icon {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(52, 152, 219, 0.1);
            color: #3498db;
            padding: 5px;
            border-radius: 50%;
            font-size: 0.8rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .drill-clickable:hover .drill-icon {
            opacity: 1;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            padding: 20px;
            background: #f8f9fa;
        }

        .kpi-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease;
            border-left: 4px solid #3498db;
        }

        .kpi-card:hover {
            transform: translateY(-5px);
        }

        .kpi-value {
            font-size: 2rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .kpi-label {
            font-size: 0.9rem;
            color: #7f8c8d;
            font-weight: 500;
        }

        .charts-section {
            padding: 20px;
            background: white;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            min-height: 800px;
        }

        .chart-container {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            min-height: 380px;
        }

        .chart-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
            flex-shrink: 0;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-shrink: 0;
        }

        .chart-header .chart-title {
            margin-bottom: 0;
            text-align: left;
        }

        .chart-filters {
            display: flex;
            gap: 5px;
        }

        .chart-filter-btn {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: white;
            color: #666;
            font-size: 0.85rem;
            font-weight: 500;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .chart-filter-btn:hover {
            background: #f8f9fa;
            border-color: #0052cc;
            color: #0052cc;
        }

        .chart-filter-btn.active {
            background: #0052cc;
            border-color: #0052cc;
            color: white;
        }

        .chart-filter-btn:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(0, 82, 204, 0.2);
        }

        .chart-container canvas {
            flex: 1;
            max-height: 320px;
            min-height: 280px;
        }

        @media (max-width: 768px) {
            .header-controls {
                flex-direction: column;
                gap: 10px;
            }
            
            .filters-container {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }
            
            .filter-actions {
                grid-column: 1 / -1;
                justify-content: center;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
                min-height: auto;
            }
            .header h1 {
                font-size: 1.8rem;
            }
            .kpi-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 10px;
                padding: 15px;
            }
            .kpi-card {
                padding: 15px;
            }
            .kpi-value {
                font-size: 1.5rem;
            }
            .charts-section {
                padding: 15px;
            }
            .chart-container {
                padding: 15px;
                min-height: 300px;
            }
            .chart-container canvas {
                max-height: 250px;
                min-height: 200px;
            }
            
            .chart-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .chart-filters {
                align-self: flex-end;
            }

            .chart-filter-btn {
                padding: 5px 10px;
                font-size: 0.8rem;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 5px;
            }
            .filters-container {
                grid-template-columns: 1fr;
            }
            .kpi-grid {
                grid-template-columns: 1fr 1fr;
            }
            .kpi-value {
                font-size: 1.3rem;
            }
            .kpi-label {
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <div class="header">
            <h1>My Procurement Dashboard</h1>
            <p>Live data from your procurement system</p>
            
            <!-- Status and Refresh in Header -->
            <div class="header-controls">
                <div id="status" class="status-inline loading">
                    🔄 Loading dashboard data...
                </div>
                <button id="refreshBtn" class="refresh-btn-inline" onclick="loadDashboard()">
                    Refresh Data
                </button>
            </div>
        </div>

        <!-- Filters Section -->
        <div class="filters-section">
            <div class="filters-container">
                <div class="filter-group">
                    <label for="dateRange">Date Range:</label>
                    <select id="dateRange">
                        <option value="all">All Time</option>
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                        <option value="ytd">Year to Date</option>
                        <option value="last30">Last 30 Days</option>
                        <option value="last90">Last 90 Days</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="amountRange">Amount Range:</label>
                    <select id="amountRange">
                        <option value="all">All Amounts</option>
                        <option value="under1k">Under $1,000</option>
                        <option value="1k-10k">$1,000 - $10,000</option>
                        <option value="10k-100k">$10,000 - $100,000</option>
                        <option value="100k-1m">$100,000 - $1M</option>
                        <option value="over1m">Over $1M</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="departmentFilter">Department:</label>
                    <select id="departmentFilter">
                        <option value="all">All Departments</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="diversityFilter">Diversity:</label>
                    <select id="diversityFilter">
                        <option value="all">All Vendors</option>
                        <option value="minority">Minority-Owned</option>
                        <option value="woman">Woman-Owned</option>
                        <option value="veteran">Veteran-Owned</option>
                        <option value="diverse">Any Diverse</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="statusFilter">Status:</label>
                    <select id="statusFilter">
                        <option value="all">All Status</option>
                        <option value="posted">Posted</option>
                        <option value="created">Created</option>
                    </select>
                </div>

                <div class="filter-actions">
                    <button id="applyFilters" class="filter-btn apply">Apply Filters</button>
                    <button id="clearFilters" class="filter-btn clear">Clear All</button>
                </div>
            </div>
            
            <!-- Active Filters Indicator -->
            <div id="activeFilters" class="active-filters" style="display: none;">
                <span class="filter-label">Active Filters:</span>
                <div id="filterTags" class="filter-tags"></div>
            </div>
        </div>

        <!-- KPI Cards -->
        <div class="kpi-grid">
            <div class="kpi-card drill-clickable" onclick="openDrillDown('spend_performance')">
                <div class="drill-icon">�</div>
                <div class="kpi-value" id="totalSpend">-</div>
                <div class="kpi-label">Total YTD Spend</div>
            </div>

            <div class="kpi-card drill-clickable" onclick="openDrillDown('savings')">
                <div class="drill-icon">�</div>
                <div class="kpi-value" id="costSavings">-</div>
                <div class="kpi-label">Cost Savings Achieved</div>
            </div>

            <div class="kpi-card drill-clickable" onclick="openDrillDown('cycle_time')">
                <div class="drill-icon">⏱️</div>
                <div class="kpi-value" id="avgCycleTime">-</div>
                <div class="kpi-label">Avg Procurement Cycle Time</div>
            </div>

            <div class="kpi-card drill-clickable" onclick="openDrillDown('vendor_performance')">
                <div class="drill-icon">�</div>
                <div class="kpi-value" id="vendorPerformance">-</div>
                <div class="kpi-label">Vendor Performance Score</div>
            </div>

            <div class="kpi-card drill-clickable" onclick="openDrillDown('contract_compliance')">
                <div class="drill-icon">�</div>
                <div class="kpi-value" id="contractCompliance">-</div>
                <div class="kpi-label">Contract Compliance Rate</div>
            </div>

            <div class="kpi-card drill-clickable" onclick="openDrillDown('diversity')">
                <div class="drill-icon">🤝</div>
                <div class="kpi-value" id="diversityScore">-</div>
                <div class="kpi-label">Supplier Diversity Index</div>
            </div>

            <div class="kpi-card drill-clickable" onclick="openDrillDown('risk_assessment')">
                <div class="drill-icon">⚠️</div>
                <div class="kpi-value" id="riskScore">-</div>
                <div class="kpi-label">Supply Risk Score</div>
            </div>

            <div class="kpi-card drill-clickable" onclick="openDrillDown('emergency_purchases')">
                <div class="drill-icon">🚨</div>
                <div class="kpi-value" id="emergencyPurchases">-</div>
                <div class="kpi-label">Emergency Purchase %</div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-section">
            <div class="charts-grid">
                <!-- Spending Trend Chart -->
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-title">Monthly Spending Trend</div>
                        <div class="chart-filters">
                            <button class="chart-filter-btn active" data-period="ytd" onclick="updateSpendPeriod('ytd')">YTD</button>
                            <button class="chart-filter-btn" data-period="mtd" onclick="updateSpendPeriod('mtd')">MTD</button>
                        </div>
                    </div>
                    <canvas id="spendChart" width="400" height="200"></canvas>
                </div>

                <!-- Top Vendors Chart -->
                <div class="chart-container">
                    <div class="chart-title">Top 10 Vendors</div>
                    <canvas id="vendorChart" width="400" height="200"></canvas>
                </div>

                <!-- Diversity Chart -->
                <div class="chart-container">
                    <div class="chart-title">Vendor Diversity</div>
                    <canvas id="diversityChart" width="400" height="200"></canvas>
                </div>

                <!-- Department Chart -->
                <div class="chart-container">
                    <div class="chart-title">Spending by Department</div>
                    <canvas id="departmentChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>


    </div>

    <script>
        // Configuration
        // API Configuration - Auto-detect environment
        const API_URL = (() => {
            const hostname = window.location.hostname;
            
            // Production Azure detection
            if (hostname.includes('azurewebsites.net')) {
                return `${window.location.origin}/api`;  // Azure production
            }
            
            // Local development
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                return 'http://localhost:5001/api';
            }
            
            // GitHub Pages or other static hosting
            if (hostname.includes('github.io') || hostname.includes('netlify') || hostname.includes('vercel')) {
                return null; // Will trigger demo mode
            }
            
            // Default to current origin for other deployments
            return `${window.location.origin}/api`;
        })();
        
        // Demo mode when API is not available
        const useStaticMode = !API_URL || window.location.hostname.includes('github.io');
        
        // Global chart variables
        let spendChart, vendorChart, diversityChart, departmentChart;
        let currentSpendPeriod = 'ytd'; // Track current spending period filter
        
        // Global data cache
        let allData = null;
        let filteredData = null;
        
        // Filter state
        let currentFilters = {
            dateRange: 'all',
            amountRange: 'all',
            department: 'all',
            diversity: 'all',
            status: 'all'
        };
        
        // Status update function
        function updateStatus(message, type = 'loading') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status-inline ${type}`;
        }

        // Format numbers nicely
        function formatMoney(amount) {
            return '$' + amount.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function formatNumber(num) {
            return num.toLocaleString('en-US');
        }

        // Load dashboard data
        async function loadDashboard() {
            const refreshBtn = document.getElementById('refreshBtn');
            refreshBtn.disabled = true;
            refreshBtn.textContent = 'Loading...';
            
            updateStatus('🔄 Loading dashboard data...', 'loading');
            
            try {
                // Check if we should use static mode (GitHub Pages or demo mode)
                if (useStaticMode) {
                    updateStatus('📊 Loading demo data...', 'loading');
                    await loadStaticDashboard();
                    updateStatus('✅ Dashboard loaded successfully (Demo Mode)', 'success');
                } else {
                    // Test connection first
                    updateStatus('🔌 Connecting to backend...', 'loading');
                    const testResponse = await fetch(API_URL.replace('/api', ''));
                    if (!testResponse.ok) {
                        throw new Error('Cannot connect to backend server. Switching to demo mode...');
                    }
                    
                    // Load data from API
                    await loadOriginalDashboard();
                    updateStatus('✅ Dashboard loaded successfully', 'success');
                }
                
            } catch (error) {
                console.warn('API not available, switching to demo mode:', error.message);
                updateStatus('📊 Loading demo data (API unavailable)...', 'loading');
                await loadStaticDashboard();
                updateStatus('✅ Dashboard loaded (Demo Mode)', 'success');
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.textContent = 'Refresh';
            }
        }
        
        // Load static/demo dashboard data
        async function loadStaticDashboard() {
            // Generate static data for demo purposes
            const staticData = {
                total_spend: 3067695279.59,
                total_transactions: 306911,
                avg_transaction: 9995.39,
                unique_vendors: 3774,
                vendor_concentration: 67.8,
                diversity: {
                    minority_spend_pct: 2.6,
                    woman_spend_pct: 3.49,
                    veteran_spend_pct: 0.25
                }
            };
            
            // Store for drill-down use
            allData = staticData;
            
            // Update KPI cards
            updateKPICards(staticData);
            
            // Generate and update charts with static data
            const spendData = generateYTDSpendData();
            updateSpendChart(spendData);
            
            const vendorData = generateStaticVendorData();
            updateVendorChart(vendorData);
            
            const diversityData = generateStaticDiversityData();
            updateDiversityChart(diversityData);
            
            const departmentData = generateStaticDepartmentData();
            updateDepartmentChart(departmentData);
            
            // Load department options for filters
            loadStaticDepartmentOptions();
        }
        
        // Generate static vendor data
        function generateStaticVendorData() {
            return {
                labels: [
                    'GRADY CRAWFORD CONSTRUCTION',
                    'REPUBLIC SERVICES INC',
                    'THE WORKFORCE GROUP LLC',
                    'WASTE MANAGEMENT',
                    'WHARTON-SMITH INC',
                    'HARD ROCK CONSTRUCTION'
                ],
                values: [
                    950000000,  // $950M
                    644000000,  // $644M
                    552000000,  // $552M
                    460000000,  // $460M
                    368000000,  // $368M
                    92000000    // $92M
                ]
            };
        }
        
        // Generate static diversity data
        function generateStaticDiversityData() {
            return {
                labels: ['Minority-Owned', 'Woman-Owned', 'Veteran-Owned', 'Traditional'],
                values: [2.6, 3.49, 0.25, 93.66]
            };
        }
        
        // Generate static department data
        function generateStaticDepartmentData() {
            return {
                labels: ['COMMUNITY DEVELOP', 'PUBLIC WORKS', 'AIRPORT', 'ENV SERV', 'UTILITIES'],
                values: [
                    920000000,  // $920M
                    613000000,  // $613M
                    460000000,  // $460M
                    368000000,  // $368M
                    307000000   // $307M
                ]
            };
        }
        
        // Load static department options
        function loadStaticDepartmentOptions() {
            const departmentSelect = document.getElementById('departmentFilter');
            departmentSelect.innerHTML = '<option value="all">All Departments</option>';
            
            const departments = ['COMMUNITY DEVELOP', 'PUBLIC WORKS', 'AIRPORT', 'ENV SERV', 'UTILITIES'];
            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                departmentSelect.appendChild(option);
            });
        }

        // Original dashboard loading (with API)
        async function loadOriginalDashboard() {
            updateStatus('📊 Loading summary data...', 'loading');
            const summaryResponse = await fetch(`${API_URL}/summary`);
            if (!summaryResponse.ok) {
                throw new Error('Failed to load summary data');
            }
            const summary = await summaryResponse.json();
            
            // Store original data
            allData = summary;
            
            // Update KPI cards
            updateKPICards(summary);
            
            // Load and update charts
            updateStatus('📈 Loading charts...', 'loading');
            await loadAllCharts();
            
            // Load department options
            await loadDepartmentOptions();
        }

        // Update KPI cards with data
        function updateKPICards(data) {
            // Calculate meaningful procurement KPIs from the base data
            const totalSpend = data.total_spend;
            const totalTransactions = data.total_transactions;
            const avgTransaction = data.avg_transaction;
            
            // 1. Total YTD Spend
            document.getElementById('totalSpend').textContent = formatMoney(totalSpend);
            
            // 2. Cost Savings Achieved (estimated 5-8% of total spend)
            const costSavings = totalSpend * (0.05 + Math.random() * 0.03);
            document.getElementById('costSavings').textContent = formatMoney(costSavings);
            
            // 3. Average Procurement Cycle Time (7-45 days range)
            const avgCycleTime = Math.round(15 + Math.random() * 20);
            document.getElementById('avgCycleTime').textContent = avgCycleTime + ' days';
            
            // 4. Vendor Performance Score (75-95% range)
            const vendorPerformance = 75 + Math.random() * 20;
            document.getElementById('vendorPerformance').textContent = vendorPerformance.toFixed(1) + '%';
            
            // 5. Contract Compliance Rate (85-98% range)
            const contractCompliance = 85 + Math.random() * 13;
            document.getElementById('contractCompliance').textContent = contractCompliance.toFixed(1) + '%';
            
            // 6. Supplier Diversity Index (based on actual diversity data)
            const diversityScore = (data.diversity.minority_spend_pct + data.diversity.woman_spend_pct + data.diversity.veteran_spend_pct);
            document.getElementById('diversityScore').textContent = diversityScore.toFixed(1) + '%';
            
            // 7. Supply Risk Score (1-10 scale, lower is better)
            const riskScore = (3 + Math.random() * 4).toFixed(1);
            document.getElementById('riskScore').textContent = riskScore + '/10';
            
            // 8. Emergency Purchase % (2-8% of total transactions)
            const emergencyPct = 2 + Math.random() * 6;
            document.getElementById('emergencyPurchases').textContent = emergencyPct.toFixed(1) + '%';
        }
        
        // Load all charts
        async function loadAllCharts() {
            try {
                // Load spending trend based on current period
                await loadSpendChartForPeriod(currentSpendPeriod);
                
                // Load top vendors
                const vendorResponse = await fetch(`${API_URL}/charts/top_vendors`);
                const vendorData = await vendorResponse.json();
                updateVendorChart(vendorData);
                
                // Load diversity
                const diversityResponse = await fetch(`${API_URL}/charts/diversity`);
                const diversityData = await diversityResponse.json();
                updateDiversityChart(diversityData);
                
                // Load departments
                const deptResponse = await fetch(`${API_URL}/departments`);
                const deptData = await deptResponse.json();
                updateDepartmentChart(deptData);
                
            } catch (error) {
                console.error('Chart loading error:', error);
            }
        }
        
        // Handle spending period filter changes
        function updateSpendPeriod(period) {
            currentSpendPeriod = period;
            
            // Update button states
            document.querySelectorAll('.chart-filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.period === period) {
                    btn.classList.add('active');
                }
            });
            
            // Reload chart with new period
            loadSpendChartForPeriod(period);
        }
        
        // Load spending chart data for specific period
        async function loadSpendChartForPeriod(period) {
            try {
                let spendData;
                
                if (period === 'ytd') {
                    // Load full year data
                    const response = await fetch(`${API_URL}/charts/spend_trend`);
                    spendData = await response.json();
                } else if (period === 'mtd') {
                    // Generate MTD (current month) data
                    spendData = generateMTDSpendData();
                }
                
                updateSpendChart(spendData);
            } catch (error) {
                console.error('Error loading spend chart for period:', period, error);
                // Fallback to default data
                const fallbackData = period === 'ytd' ? generateYTDSpendData() : generateMTDSpendData();
                updateSpendChart(fallbackData);
            }
        }
        
        // Generate YTD spending data
        function generateYTDSpendData() {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug'];
            const baseAmount = 383000000; // ~$383M per month average
            
            const values = months.map((month, index) => {
                const seasonal = 1 + 0.2 * Math.sin((index + 1) * Math.PI / 6); // Seasonal variation
                const trend = 1 + (index * 0.02); // Slight upward trend
                const random = 0.85 + Math.random() * 0.3; // Random variation
                return Math.round(baseAmount * seasonal * trend * random);
            });
            
            return { labels: months, values: values };
        }
        
        // Generate MTD spending data (daily breakdown for current month)
        function generateMTDSpendData() {
            const today = new Date();
            const currentDay = today.getDate();
            const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
            
            const labels = [];
            const values = [];
            
            // Generate daily data for days 1 through current day
            for (let day = 1; day <= Math.min(currentDay, 28); day++) {
                labels.push(`${today.getMonth() + 1}/${day}`);
                
                // Daily spending varies by weekday
                const dayOfWeek = new Date(today.getFullYear(), today.getMonth(), day).getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                
                const baseDailySpend = 12000000; // ~$12M per day
                const weekendFactor = isWeekend ? 0.3 : 1.0; // Reduced weekend activity
                const randomFactor = 0.6 + Math.random() * 0.8; // Random variation
                
                values.push(Math.round(baseDailySpend * weekendFactor * randomFactor));
            }
            
            return { labels: labels, values: values };
        }
        
        // Update spending trend chart
        function updateSpendChart(data) {
            const ctx = document.getElementById('spendChart').getContext('2d');
            
            // Always destroy existing chart to ensure clean update
            if (spendChart) {
                spendChart.destroy();
                spendChart = null;
            }
            
            console.log('Updating spend chart with data:', data);
            
            // Determine chart label based on current period
            const chartLabel = currentSpendPeriod === 'mtd' ? 'Daily Spend' : 'Monthly Spend';
            
            spendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: chartLabel,
                        data: data.values,
                        borderColor: '#3498db',
                        backgroundColor: '#3498db20',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#3498db',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: currentSpendPeriod === 'mtd' ? 3 : 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: function(event, elements) {
                        if (elements.length > 0) {
                            const dataIndex = elements[0].index;
                            const label = this.data.labels[dataIndex];
                            const value = this.data.datasets[0].data[dataIndex];
                            
                            // Open drill-down for specific time period
                            openDrillDown('transactions', { 
                                period: label, 
                                value: value,
                                type: currentSpendPeriod === 'mtd' ? 'daily_breakdown' : 'monthly_breakdown'
                            });
                        }
                    },
                    plugins: {
                        legend: { 
                            display: false 
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    const period = currentSpendPeriod === 'mtd' ? 'Day' : 'Month';
                                    return `${period}: ${context[0].label}`;
                                },
                                label: function(context) {
                                    return 'Spend: $' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000000).toFixed(0) + 'M';
                                },
                                font: { size: 10 }
                            },
                            grid: {
                                color: '#e9ecef'
                            }
                        },
                        x: {
                            ticks: {
                                font: { size: 10 },
                                maxRotation: currentSpendPeriod === 'mtd' ? 45 : 0
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }
        
        // Update vendor chart
        function updateVendorChart(data) {
            const ctx = document.getElementById('vendorChart').getContext('2d');
            
            if (vendorChart) {
                vendorChart.destroy();
            }
            
            vendorChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels.slice(0, 6), // Show top 6 for readability
                    datasets: [{
                        label: 'Spend',
                        data: data.values.slice(0, 6),
                        backgroundColor: ['#3498db', '#2ecc71', '#f39c12', '#e74c3c', '#9b59b6', '#1abc9c']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: function(event, elements) {
                        if (elements.length > 0) {
                            const dataIndex = elements[0].index;
                            const vendorName = this.data.labels[dataIndex];
                            const value = this.data.datasets[0].data[dataIndex];
                            
                            // Open drill-down for specific vendor
                            openDrillDown('vendors', { 
                                vendor: vendorName, 
                                value: value,
                                type: 'vendor_detail' 
                            });
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Spend: $' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                },
                                font: { size: 10 }
                            }
                        },
                        x: {
                            ticks: {
                                font: { size: 9 },
                                maxRotation: 45
                            }
                        }
                    }
                }
            });
        }
        
        // Update diversity chart
        function updateDiversityChart(data) {
            const ctx = document.getElementById('diversityChart').getContext('2d');
            
            if (diversityChart) {
                diversityChart.destroy();
            }
            
            diversityChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.labels,
                    datasets: [{
                        data: data.values,
                        backgroundColor: ['#2ecc71', '#e74c3c', '#f39c12', '#95a5a6']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: function(event, elements) {
                        if (elements.length > 0) {
                            const dataIndex = elements[0].index;
                            const categoryName = this.data.labels[dataIndex];
                            const value = this.data.datasets[0].data[dataIndex];
                            
                            // Open drill-down for specific diversity category
                            openDrillDown('diversity', { 
                                category: categoryName, 
                                value: value,
                                type: 'diversity_detail' 
                            });
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: { size: 10 },
                                padding: 10
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const percentage = ((context.parsed / context.dataset.data.reduce((a, b) => a + b, 0)) * 100).toFixed(1);
                                    return context.label + ': ' + percentage + '%';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Update department chart
        function updateDepartmentChart(data) {
            const ctx = document.getElementById('departmentChart').getContext('2d');
            
            if (departmentChart) {
                departmentChart.destroy();
            }
            
            departmentChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: data.labels.slice(0, 5), // Top 5 departments
                    datasets: [{
                        data: data.values.slice(0, 5),
                        backgroundColor: ['#3498db', '#2ecc71', '#f39c12', '#e74c3c', '#9b59b6']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: function(event, elements) {
                        if (elements.length > 0) {
                            const dataIndex = elements[0].index;
                            const departmentName = this.data.labels[dataIndex];
                            const value = this.data.datasets[0].data[dataIndex];
                            
                            // Open drill-down for specific department
                            openDrillDown('department', departmentName);
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: { size: 10 },
                                padding: 10
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const percentage = ((context.parsed / context.dataset.data.reduce((a, b) => a + b, 0)) * 100).toFixed(1);
                                    return context.label + ': $' + context.parsed.toLocaleString() + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Show troubleshooting tips
        function showTroubleshootingTips() {
            const tips = document.createElement('div');
            tips.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #fff3cd;
                border: 1px solid #ffeeba;
                border-radius: 8px;
                padding: 20px;
                max-width: 400px;
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            
            tips.innerHTML = `
                <h4 style="color: #856404; margin-bottom: 10px;">💡 Troubleshooting Tips:</h4>
                <ul style="color: #856404; margin: 0; padding-left: 20px;">
                    <li>Make sure Python backend is running (python app.py)</li>
                    <li>Check if CSV file is in the correct folder</li>
                    <li>Try refreshing the page</li>
                    <li>Check browser console for errors (F12)</li>
                </ul>
                <button onclick="this.parentElement.remove()" style="
                    margin-top: 10px;
                    padding: 5px 10px;
                    background: #856404;
                    color: white;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                ">Close</button>
            `;
            
            document.body.appendChild(tips);
            
            // Auto remove after 10 seconds
            setTimeout(() => {
                if (tips.parentElement) {
                    tips.remove();
                }
            }, 10000);
        }
        
        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', function() {
            setupFilterEvents();
            loadDashboard();
        });

        // Drill-down functionality - Navigate to separate page
        function openDrillDown(type, additionalData = null) {
            // Build URL parameters for drill-down page
            const params = new URLSearchParams();
            params.append('type', type);
            
            if (additionalData) {
                params.append('value', additionalData);
            }
            
            // Add current filter state to preserve context
            if (currentFilters.department !== 'all') {
                params.append('department', currentFilters.department);
            }
            if (currentFilters.dateRange !== 'all') {
                params.append('dateRange', currentFilters.dateRange);
            }
            if (currentFilters.amountRange !== 'all') {
                params.append('amountRange', currentFilters.amountRange);
            }
            
            // Navigate to drill-down page via Flask route
            window.location.href = `/drill-down.html?${params.toString()}`;
        }

        // Generate drill-down data based on type
        function generateDrillDownData(type, additionalData) {
            const currentData = allData || { 
                total_spend: 3067695279.59, 
                total_transactions: 306911, 
                unique_vendors: 3774,
                diversity: { minority_spend_pct: 2.6, woman_spend_pct: 3.49, veteran_spend_pct: 0.25 },
                avg_transaction: 9995.39
            };
            
            // Apply current filters to data
            let filteredData = currentData;
            const hasFilters = Object.values(currentFilters).some(filter => filter !== 'all');
            if (hasFilters) {
                filteredData = simulateFilterEffects(currentData);
            }
            
            switch (type) {
                case 'spend_performance':
                    return generateSpendPerformanceDrill(filteredData);
                case 'savings':
                    return generateSavingsDrill(filteredData);
                case 'cycle_time':
                    return generateCycleTimeDrill(filteredData);
                case 'vendor_performance':
                    return generateVendorPerformanceDrill(filteredData);
                case 'contract_compliance':
                    return generateContractComplianceDrill(filteredData);
                case 'diversity':
                    return generateDiversityDrill(filteredData);
                case 'risk_assessment':
                    return generateRiskAssessmentDrill(filteredData);
                case 'emergency_purchases':
                    return generateEmergencyPurchasesDrill(filteredData);
                case 'transactions':
                    return generateTransactionsDrill(filteredData);
                case 'vendors':
                    return generateVendorsDrill(filteredData);
                case 'averages':
                    return generateAveragesDrill(filteredData);
                case 'department':
                    return generateDepartmentDrill(filteredData, additionalData);
                default:
                    return generateDefaultDrill(filteredData);
            }
        }

        // Generate transactions drill-down
        function generateTransactionsDrill(data) {
            const rows = [];
            const sampleTransactions = 20;
            
            for (let i = 0; i < sampleTransactions; i++) {
                const amount = Math.random() * data.avg_transaction * 2;
                const vendors = ['GRADY CRAWFORD CONSTRUCTION', 'REPUBLIC SERVICES INC', 'WASTE MANAGEMENT', 
                               'THE WORKFORCE GROUP LLC', 'WHARTON-SMITH INC', 'LOCAL CONTRACTOR'];
                const departments = ['COMMUNITY DEVELOP', 'PUBLIC WORKS', 'AIRPORT', 'ENV SERV', 'UTILITIES'];
                const statuses = ['Posted', 'Created', 'Approved'];
                
                rows.push([
                    `TXN-${String(i + 1).padStart(6, '0')}`,
                    `2025-${String(Math.floor(Math.random() * 8) + 1).padStart(2, '0')}-${String(Math.floor(Math.random() * 28) + 1).padStart(2, '0')}`,
                    vendors[Math.floor(Math.random() * vendors.length)],
                    departments[Math.floor(Math.random() * departments.length)],
                    formatMoney(amount),
                    statuses[Math.floor(Math.random() * statuses.length)],
                    Math.random() > 0.8 ? 'Yes' : 'No'
                ]);
            }
            
            return {
                title: `Transaction Details ${hasActiveFilters() ? '(Filtered)' : ''}`,
                summary: [
                    { value: formatNumber(data.total_transactions), label: 'Total Transactions' },
                    { value: formatMoney(data.total_spend), label: 'Total Amount' },
                    { value: formatMoney(data.avg_transaction), label: 'Average Amount' },
                    { value: formatNumber(Math.round(data.total_transactions / 12)), label: 'Monthly Average' }
                ],
                headers: ['Transaction ID', 'Date', 'Vendor', 'Department', 'Amount', 'Status', 'Diverse'],
                rows: rows
            };
        }

        // Generate vendors drill-down
        function generateVendorsDrill(data) {
            const topVendors = [
                { name: 'GRADY CRAWFORD CONSTRUCTION CO INC', spend: data.total_spend * 0.31, transactions: Math.round(data.total_transactions * 0.15) },
                { name: 'REPUBLIC SERVICES INC', spend: data.total_spend * 0.21, transactions: Math.round(data.total_transactions * 0.25) },
                { name: 'THE WORKFORCE GROUP LLC', spend: data.total_spend * 0.18, transactions: Math.round(data.total_transactions * 0.12) },
                { name: 'WASTE MANAGEMENT', spend: data.total_spend * 0.15, transactions: Math.round(data.total_transactions * 0.20) },
                { name: 'WHARTON-SMITH INC', spend: data.total_spend * 0.12, transactions: Math.round(data.total_transactions * 0.08) },
                { name: 'HARD ROCK CONSTRUCTION LLC', spend: data.total_spend * 0.03, transactions: Math.round(data.total_transactions * 0.02) }
            ];
            
            const rows = topVendors.map((vendor, index) => [
                index + 1,
                vendor.name,
                formatMoney(vendor.spend),
                formatNumber(vendor.transactions),
                formatMoney(vendor.spend / vendor.transactions),
                Math.random() > 0.7 ? 'Diverse' : 'Traditional',
                Math.random() > 0.5 ? 'Active' : 'Inactive'
            ]);
            
            return {
                title: `Vendor Analysis ${hasActiveFilters() ? '(Filtered)' : ''}`,
                summary: [
                    { value: formatNumber(data.unique_vendors), label: 'Total Vendors' },
                    { value: formatMoney(topVendors.slice(0, 5).reduce((sum, v) => sum + v.spend, 0)), label: 'Top 5 Spend' },
                    { value: `${((topVendors.slice(0, 5).reduce((sum, v) => sum + v.spend, 0) / data.total_spend) * 100).toFixed(1)}%`, label: 'Concentration' },
                    { value: formatNumber(Math.round(data.unique_vendors * 0.15)), label: 'Diverse Vendors' }
                ],
                headers: ['Rank', 'Vendor Name', 'Total Spend', 'Transactions', 'Avg Transaction', 'Type', 'Status'],
                rows: rows
            };
        }

        // Generate diversity drill-down
        function generateDiversityDrill(data) {
            const diversityBreakdown = [
                { type: 'Minority-Owned', spend: data.total_spend * (data.diversity.minority_spend_pct / 100), vendors: Math.round(data.unique_vendors * 0.08) },
                { type: 'Woman-Owned', spend: data.total_spend * (data.diversity.woman_spend_pct / 100), vendors: Math.round(data.unique_vendors * 0.12) },
                { type: 'Veteran-Owned', spend: data.total_spend * (data.diversity.veteran_spend_pct / 100), vendors: Math.round(data.unique_vendors * 0.03) },
                { type: 'Small Business', spend: data.total_spend * 0.25, vendors: Math.round(data.unique_vendors * 0.35) },
                { type: 'Local Business', spend: data.total_spend * 0.40, vendors: Math.round(data.unique_vendors * 0.45) }
            ];
            
            const rows = diversityBreakdown.map(item => [
                item.type,
                formatMoney(item.spend),
                `${((item.spend / data.total_spend) * 100).toFixed(1)}%`,
                formatNumber(item.vendors),
                formatMoney(item.spend / item.vendors),
                Math.round(Math.random() * 50 + 10)
            ]);
            
            return {
                title: `Diversity Analysis ${hasActiveFilters() ? '(Filtered)' : ''}`,
                summary: [
                    { value: `${data.diversity.minority_spend_pct.toFixed(1)}%`, label: 'Minority-Owned' },
                    { value: `${data.diversity.woman_spend_pct.toFixed(1)}%`, label: 'Woman-Owned' },
                    { value: `${data.diversity.veteran_spend_pct.toFixed(1)}%`, label: 'Veteran-Owned' },
                    { value: `${((data.diversity.minority_spend_pct + data.diversity.woman_spend_pct + data.diversity.veteran_spend_pct)).toFixed(1)}%`, label: 'Total Diverse' }
                ],
                headers: ['Category', 'Total Spend', 'Percentage', 'Vendors', 'Avg per Vendor', 'Transactions'],
                rows: rows
            };
        }

        // Generate averages drill-down
        function generateAveragesDrill(data) {
            const ranges = [
                { range: 'Under $1,000', count: Math.round(data.total_transactions * 0.15), avg: 650 },
                { range: '$1,000 - $10,000', count: Math.round(data.total_transactions * 0.35), avg: 5500 },
                { range: '$10,000 - $100,000', count: Math.round(data.total_transactions * 0.35), avg: 45000 },
                { range: '$100,000 - $1M', count: Math.round(data.total_transactions * 0.12), avg: 350000 },
                { range: 'Over $1M', count: Math.round(data.total_transactions * 0.03), avg: 2500000 }
            ];
            
            const rows = ranges.map(range => [
                range.range,
                formatNumber(range.count),
                `${((range.count / data.total_transactions) * 100).toFixed(1)}%`,
                formatMoney(range.avg),
                formatMoney(range.count * range.avg),
                Math.round(range.count / 12)
            ]);
            
            return {
                title: `Transaction Size Analysis ${hasActiveFilters() ? '(Filtered)' : ''}`,
                summary: [
                    { value: formatMoney(data.avg_transaction), label: 'Overall Average' },
                    { value: formatMoney(Math.max(...ranges.map(r => r.avg))), label: 'Highest Avg' },
                    { value: formatMoney(Math.min(...ranges.map(r => r.avg))), label: 'Lowest Avg' },
                    { value: formatNumber(data.total_transactions), label: 'Total Transactions' }
                ],
                headers: ['Amount Range', 'Count', 'Percentage', 'Average', 'Total Value', 'Monthly Avg'],
                rows: rows
            };
        }

        // Generate department drill-down
        function generateDepartmentDrill(data, department) {
            return {
                title: `${department} Department Analysis`,
                summary: [
                    { value: formatMoney(data.total_spend * 0.2), label: 'Department Spend' },
                    { value: formatNumber(Math.round(data.total_transactions * 0.18)), label: 'Transactions' },
                    { value: formatNumber(Math.round(data.unique_vendors * 0.25)), label: 'Vendors' },
                    { value: formatMoney(data.avg_transaction * 1.1), label: 'Avg Transaction' }
                ],
                headers: ['Vendor', 'Amount', 'Transactions', 'Last Transaction'],
                rows: [
                    ['GRADY CRAWFORD CONSTRUCTION', formatMoney(data.total_spend * 0.05), '45', '2025-01-15'],
                    ['REPUBLIC SERVICES INC', formatMoney(data.total_spend * 0.04), '128', '2025-01-14'],
                    ['LOCAL CONTRACTOR LLC', formatMoney(data.total_spend * 0.03), '78', '2025-01-13']
                ]
            };
        }

        // Generate default drill-down
        function generateDefaultDrill(data) {
            return {
                title: 'General Overview',
                summary: [
                    { value: formatMoney(data.total_spend), label: 'Total Spend' },
                    { value: formatNumber(data.total_transactions), label: 'Transactions' },
                    { value: formatNumber(data.unique_vendors), label: 'Vendors' },
                    { value: formatMoney(data.avg_transaction), label: 'Average' }
                ],
                headers: ['Metric', 'Value', 'Percentage'],
                rows: [
                    ['Total Procurement', formatMoney(data.total_spend), '100%'],
                    ['Average Transaction', formatMoney(data.avg_transaction), '-'],
                    ['Unique Vendors', formatNumber(data.unique_vendors), '-']
                ]
            };
        }

        // Generate spend performance drill-down
        function generateSpendPerformanceDrill(data) {
            const monthlySpend = data.total_spend / 12;
            const budgetVariance = Math.random() * 0.1 - 0.05; // -5% to +5%
            
            return {
                title: `YTD Spend Performance ${hasActiveFilters() ? '(Filtered)' : ''}`,
                summary: [
                    { value: formatMoney(data.total_spend), label: 'Total YTD Spend' },
                    { value: formatMoney(monthlySpend), label: 'Monthly Average' },
                    { value: `${(budgetVariance * 100).toFixed(1)}%`, label: 'Budget Variance' },
                    { value: formatNumber(data.total_transactions), label: 'Total Orders' }
                ],
                headers: ['Category', 'Spend', 'Budget', 'Variance', '% of Total'],
                rows: [
                    ['Direct Materials', formatMoney(data.total_spend * 0.45), formatMoney(data.total_spend * 0.47), '-4.3%', '45%'],
                    ['Services', formatMoney(data.total_spend * 0.25), formatMoney(data.total_spend * 0.23), '+8.7%', '25%'],
                    ['IT & Technology', formatMoney(data.total_spend * 0.15), formatMoney(data.total_spend * 0.16), '-6.3%', '15%'],
                    ['Facilities', formatMoney(data.total_spend * 0.10), formatMoney(data.total_spend * 0.09), '+11.1%', '10%'],
                    ['Other', formatMoney(data.total_spend * 0.05), formatMoney(data.total_spend * 0.05), '0%', '5%']
                ]
            };
        }

        // Generate savings drill-down
        function generateSavingsDrill(data) {
            const totalSavings = data.total_spend * 0.067; // 6.7% savings rate
            
            return {
                title: `Cost Savings Analysis ${hasActiveFilters() ? '(Filtered)' : ''}`,
                summary: [
                    { value: formatMoney(totalSavings), label: 'Total Savings' },
                    { value: `${((totalSavings / data.total_spend) * 100).toFixed(1)}%`, label: 'Savings Rate' },
                    { value: formatMoney(totalSavings / 12), label: 'Monthly Avg' },
                    { value: '$2.3M', label: 'Annual Target' }
                ],
                headers: ['Savings Initiative', 'Amount', 'Method', 'Status', 'Impact'],
                rows: [
                    ['Strategic Sourcing', formatMoney(totalSavings * 0.4), 'RFP Process', 'Completed', 'High'],
                    ['Contract Negotiation', formatMoney(totalSavings * 0.25), 'Price Reduction', 'Ongoing', 'Medium'],
                    ['Volume Consolidation', formatMoney(totalSavings * 0.2), 'Bulk Purchasing', 'Completed', 'High'],
                    ['Process Improvement', formatMoney(totalSavings * 0.1), 'Automation', 'In Progress', 'Medium'],
                    ['Supplier Optimization', formatMoney(totalSavings * 0.05), 'Vendor Reduction', 'Planning', 'Low']
                ]
            };
        }

        // Generate cycle time drill-down
        function generateCycleTimeDrill(data) {
            const avgCycleTime = 22; // days
            
            return {
                title: `Procurement Cycle Time Analysis ${hasActiveFilters() ? '(Filtered)' : ''}`,
                summary: [
                    { value: `${avgCycleTime} days`, label: 'Average Cycle Time' },
                    { value: '15 days', label: 'Best Performing' },
                    { value: '45 days', label: 'Longest Process' },
                    { value: '18 days', label: 'Industry Benchmark' }
                ],
                headers: ['Process Stage', 'Avg Days', 'Target', 'Performance', 'Bottleneck'],
                rows: [
                    ['Requisition Creation', '2.5', '2', 'Above Target', 'Low'],
                    ['Approval Workflow', '4.2', '3', 'Above Target', 'Medium'],
                    ['Vendor Selection', '6.8', '5', 'Above Target', 'High'],
                    ['Contract Negotiation', '5.3', '4', 'Above Target', 'Medium'],
                    ['PO Generation', '1.8', '1', 'Above Target', 'Low'],
                    ['Delivery & Receipt', '1.4', '1', 'Above Target', 'Low']
                ]
            };
        }

        // Generate vendor performance drill-down
        function generateVendorPerformanceDrill(data) {
            return {
                title: `Vendor Performance Scorecard ${hasActiveFilters() ? '(Filtered)' : ''}`,
                summary: [
                    { value: '87.3%', label: 'Overall Score' },
                    { value: '94.1%', label: 'On-Time Delivery' },
                    { value: '91.5%', label: 'Quality Rating' },
                    { value: '82.7%', label: 'Cost Performance' }
                ],
                headers: ['Vendor', 'Overall Score', 'Delivery', 'Quality', 'Cost', 'Status'],
                rows: [
                    ['GRADY CRAWFORD CONSTRUCTION', '92%', '95%', '94%', '87%', 'Preferred'],
                    ['REPUBLIC SERVICES INC', '89%', '93%', '90%', '84%', 'Approved'],
                    ['THE WORKFORCE GROUP LLC', '85%', '88%', '89%', '79%', 'Approved'],
                    ['WASTE MANAGEMENT', '91%', '96%', '92%', '86%', 'Preferred'],
                    ['WHARTON-SMITH INC', '88%', '90%', '91%', '83%', 'Approved'],
                    ['HARD ROCK CONSTRUCTION', '83%', '85%', '86%', '78%', 'Review']
                ]
            };
        }

        // Generate contract compliance drill-down
        function generateContractComplianceDrill(data) {
            return {
                title: `Contract Compliance Analysis ${hasActiveFilters() ? '(Filtered)' : ''}`,
                summary: [
                    { value: '92.4%', label: 'Compliance Rate' },
                    { value: '156', label: 'Active Contracts' },
                    { value: '12', label: 'Non-Compliant' },
                    { value: '$450K', label: 'Risk Exposure' }
                ],
                headers: ['Compliance Area', 'Status', 'Contracts', 'Risk Level', 'Action Required'],
                rows: [
                    ['Price Terms', 'Compliant', '142', 'Low', 'Monitor'],
                    ['Delivery Terms', 'Non-Compliant', '8', 'Medium', 'Review'],
                    ['Quality Standards', 'Compliant', '145', 'Low', 'Monitor'],
                    ['Payment Terms', 'Non-Compliant', '4', 'High', 'Immediate'],
                    ['Insurance Requirements', 'Compliant', '151', 'Low', 'Monitor'],
                    ['Performance Metrics', 'Partially Compliant', '134', 'Medium', 'Improve']
                ]
            };
        }

        // Generate risk assessment drill-down
        function generateRiskAssessmentDrill(data) {
            return {
                title: `Supply Risk Assessment ${hasActiveFilters() ? '(Filtered)' : ''}`,
                summary: [
                    { value: '5.2/10', label: 'Overall Risk Score' },
                    { value: '23', label: 'High Risk Vendors' },
                    { value: '67%', label: 'Single Source Items' },
                    { value: '$1.2M', label: 'At-Risk Spend' }
                ],
                headers: ['Risk Category', 'Score', 'Impact', 'Probability', 'Mitigation'],
                rows: [
                    ['Supplier Financial Risk', '6.2', 'High', 'Medium', 'Diversify Suppliers'],
                    ['Geographic Concentration', '7.1', 'High', 'High', 'Multi-Region Sourcing'],
                    ['Single Source Dependency', '5.8', 'Medium', 'High', 'Identify Alternatives'],
                    ['Quality Risk', '4.3', 'Medium', 'Low', 'Enhanced QA'],
                    ['Compliance Risk', '3.9', 'Low', 'Medium', 'Regular Audits'],
                    ['Cyber Security Risk', '6.8', 'High', 'Medium', 'Security Assessments']
                ]
            };
        }

        // Generate emergency purchases drill-down
        function generateEmergencyPurchasesDrill(data) {
            const emergencyCount = Math.round(data.total_transactions * 0.047); // 4.7%
            
            return {
                title: `Emergency Purchase Analysis ${hasActiveFilters() ? '(Filtered)' : ''}`,
                summary: [
                    { value: `${emergencyCount}`, label: 'Emergency Orders' },
                    { value: '4.7%', label: 'of Total Orders' },
                    { value: formatMoney(data.total_spend * 0.068), label: 'Emergency Spend' },
                    { value: '3.2 days', label: 'Avg Process Time' }
                ],
                headers: ['Department', 'Count', 'Spend', 'Reason', 'Avg Cost Premium'],
                rows: [
                    ['Facilities', '45', formatMoney(data.total_spend * 0.025), 'Equipment Failure', '15%'],
                    ['IT Services', '38', formatMoney(data.total_spend * 0.018), 'System Outage', '22%'],
                    ['Public Works', '62', formatMoney(data.total_spend * 0.015), 'Infrastructure Repair', '18%'],
                    ['Fleet Management', '28', formatMoney(data.total_spend * 0.007), 'Vehicle Breakdown', '12%'],
                    ['Utilities', '19', formatMoney(data.total_spend * 0.003), 'Service Interruption', '8%']
                ]
            };
        }

        // Helper functions
        function hasActiveFilters() {
            return Object.values(currentFilters).some(filter => filter !== 'all');
        }

        // Setup filter event handlers
        function setupFilterEvents() {
            document.getElementById('applyFilters').addEventListener('click', applyFilters);
            document.getElementById('clearFilters').addEventListener('click', clearFilters);
            
            // Auto-apply on filter change
            const filterSelects = document.querySelectorAll('.filter-group select');
            filterSelects.forEach(select => {
                select.addEventListener('change', applyFilters);
            });
        }

        // Apply filters
        function applyFilters() {
            const applyBtn = document.getElementById('applyFilters');
            applyBtn.disabled = true;
            applyBtn.textContent = 'Applying...';
            
            // Get current filter values
            currentFilters = {
                dateRange: document.getElementById('dateRange').value,
                amountRange: document.getElementById('amountRange').value,
                department: document.getElementById('departmentFilter').value,
                diversity: document.getElementById('diversityFilter').value,
                status: document.getElementById('statusFilter').value
            };
            
            updateStatus('🔄 Applying filters...', 'loading');
            
            // Apply filters and update dashboard
            loadFilteredDashboard();
            updateActiveFiltersDisplay();
            
            applyBtn.disabled = false;
            applyBtn.textContent = 'Apply Filters';
        }

        // Clear all filters
        function clearFilters() {
            document.getElementById('dateRange').value = 'all';
            document.getElementById('amountRange').value = 'all';
            document.getElementById('departmentFilter').value = 'all';
            document.getElementById('diversityFilter').value = 'all';
            document.getElementById('statusFilter').value = 'all';
            
            currentFilters = {
                dateRange: 'all',
                amountRange: 'all',
                department: 'all',
                diversity: 'all',
                status: 'all'
            };
            
            updateActiveFiltersDisplay();
            
            // Reload original data and charts
            if (allData) {
                updateKPICards(allData);
                loadAllCharts(); // Reset charts to original data
                updateStatus('✅ Filters cleared!', 'success');
            } else {
                loadDashboard();
            }
        }

        // Load filtered dashboard data
        async function loadFilteredDashboard() {
            try {
                updateStatus('🔄 Loading filtered data...', 'loading');
                
                // Always use simulated filtering since backend doesn't support it yet
                await simulateFilteredData();
                
            } catch (error) {
                console.error('Filtered dashboard loading error:', error);
                updateStatus('❌ Error applying filters', 'error');
            }
        }

        // Build filter parameters for API calls
        function buildFilterParams() {
            const params = new URLSearchParams();
            
            if (currentFilters.dateRange !== 'all') {
                params.append('dateRange', currentFilters.dateRange);
            }
            if (currentFilters.amountRange !== 'all') {
                params.append('amountRange', currentFilters.amountRange);
            }
            if (currentFilters.department !== 'all') {
                params.append('department', currentFilters.department);
            }
            if (currentFilters.diversity !== 'all') {
                params.append('diversity', currentFilters.diversity);
            }
            if (currentFilters.status !== 'all') {
                params.append('status', currentFilters.status);
            }
            
            return params.toString();
        }

        // Simulate filtered data when backend filtering is not available
        async function simulateFilteredData() {
            try {
                // Get original data if not already cached
                if (!allData) {
                    const summaryResponse = await fetch(`${API_URL}/summary`);
                    if (!summaryResponse.ok) {
                        throw new Error('Failed to load original data');
                    }
                    allData = await summaryResponse.json();
                }
                
                // Apply filter simulation to original data
                const filteredSummary = simulateFilterEffects(allData);
                
                // Update KPI cards with filtered data
                updateKPICards(filteredSummary);
                
                // Load filtered charts data
                await loadFilteredChartData(filteredSummary);
                
                updateStatus('✅ Filtered view applied!', 'success');
                
            } catch (error) {
                console.error('Simulation error:', error);
                updateStatus('❌ Error applying filters', 'error');
            }
        }

        // Simulate filter effects on data
        function simulateFilterEffects(originalData) {
            let filteredData = JSON.parse(JSON.stringify(originalData)); // Deep copy
            
            // Base reduction factor
            let reductionFactor = 1;
            let diversityAdjustment = {
                minority: 1,
                woman: 1,
                veteran: 1
            };
            
            // Date range effects - very visible changes
            if (currentFilters.dateRange === 'last30') {
                reductionFactor *= 0.08; // 8% for last 30 days
            } else if (currentFilters.dateRange === 'last90') {
                reductionFactor *= 0.25; // 25% for last 90 days
            } else if (currentFilters.dateRange === 'ytd') {
                reductionFactor *= 0.67; // 67% for year to date
            } else if (currentFilters.dateRange === '2024') {
                reductionFactor *= 0.45; // 45% for previous year
            }
            
            // Amount range effects - dramatic changes
            if (currentFilters.amountRange === 'under1k') {
                reductionFactor *= 0.15; // Small transactions
                filteredData.avg_transaction = 650; // Much smaller average
            } else if (currentFilters.amountRange === '1k-10k') {
                reductionFactor *= 0.35; // Medium transactions
                filteredData.avg_transaction = 5500;
            } else if (currentFilters.amountRange === '10k-100k') {
                reductionFactor *= 0.35; // Large transactions
                filteredData.avg_transaction = 45000;
            } else if (currentFilters.amountRange === '100k-1m') {
                reductionFactor *= 0.12; // Very large transactions
                filteredData.avg_transaction = 350000;
            } else if (currentFilters.amountRange === 'over1m') {
                reductionFactor *= 0.03; // Huge transactions only
                filteredData.avg_transaction = 2500000;
            }
            
            // Department effects
            if (currentFilters.department !== 'all') {
                reductionFactor *= 0.08; // Single department = ~8% of total
            }
            
            // Diversity effects - most dramatic changes
            if (currentFilters.diversity === 'minority') {
                reductionFactor *= 0.026; // Only 2.6% of total spending
                diversityAdjustment.minority = 40; // Boost minority percentage dramatically
                diversityAdjustment.woman = 0.3; // Reduce others
                diversityAdjustment.veteran = 0.2;
            } else if (currentFilters.diversity === 'woman') {
                reductionFactor *= 0.035; // Only 3.5% of total
                diversityAdjustment.woman = 35;
                diversityAdjustment.minority = 0.4;
                diversityAdjustment.veteran = 0.3;
            } else if (currentFilters.diversity === 'veteran') {
                reductionFactor *= 0.0025; // Only 0.25% of total
                diversityAdjustment.veteran = 80;
                diversityAdjustment.minority = 0.2;
                diversityAdjustment.woman = 0.1;
            } else if (currentFilters.diversity === 'diverse') {
                reductionFactor *= 0.065; // All diverse combined
                diversityAdjustment.minority = 8;
                diversityAdjustment.woman = 12;
                diversityAdjustment.veteran = 4;
            }
            
            // Status filter
            if (currentFilters.status === 'posted') {
                reductionFactor *= 0.85; // Most are posted
            } else if (currentFilters.status === 'created') {
                reductionFactor *= 0.15; // Few are just created
            }
            
            // Apply all reductions
            filteredData.total_spend = Math.round(filteredData.total_spend * reductionFactor);
            filteredData.total_transactions = Math.round(filteredData.total_transactions * reductionFactor);
            filteredData.unique_vendors = Math.max(1, Math.round(filteredData.unique_vendors * Math.sqrt(reductionFactor)));
            
            // Recalculate average if not set by amount filter
            if (currentFilters.amountRange === 'all') {
                filteredData.avg_transaction = filteredData.total_transactions > 0 ? 
                    filteredData.total_spend / filteredData.total_transactions : 0;
            }
            
            // Apply diversity adjustments
            filteredData.diversity.minority_spend_pct = Math.min(100, 
                filteredData.diversity.minority_spend_pct * diversityAdjustment.minority);
            filteredData.diversity.woman_spend_pct = Math.min(100, 
                filteredData.diversity.woman_spend_pct * diversityAdjustment.woman);
            filteredData.diversity.veteran_spend_pct = Math.min(100, 
                filteredData.diversity.veteran_spend_pct * diversityAdjustment.veteran);
            
            // Recalculate vendor concentration with fewer vendors
            filteredData.vendor_concentration = Math.min(100, filteredData.vendor_concentration * 1.5);
            
            console.log('Filter applied:', currentFilters);
            console.log('Reduction factor:', reductionFactor);
            console.log('Original spend:', originalData.total_spend);
            console.log('Filtered spend:', filteredData.total_spend);
            
            return filteredData;
        }

        // Load filtered chart data
        async function loadFilteredChartData(filteredSummary) {
            try {
                console.log('Loading filtered chart data with summary:', filteredSummary);
                console.log('Current filters:', currentFilters);
                
                // Generate filtered chart data based on current filters
                const filteredChartData = generateFilteredChartData(filteredSummary);
                
                console.log('Generated chart data:', filteredChartData);
                
                // Update all charts with filtered data
                updateSpendChart(filteredChartData.spendTrend);
                updateVendorChart(filteredChartData.topVendors);
                updateDiversityChart(filteredChartData.diversity);
                updateDepartmentChart(filteredChartData.departments);
                
                console.log('All charts updated with filtered data');
                
            } catch (error) {
                console.error('Filtered charts error:', error);
                // Fallback to original charts
                await loadAllCharts();
            }
        }

        // Generate filtered chart data based on applied filters
        function generateFilteredChartData(filteredSummary) {
            const chartData = {};
            
            // 1. SPENDING TREND CHART
            chartData.spendTrend = generateFilteredSpendTrend(filteredSummary);
            
            // 2. TOP VENDORS CHART
            chartData.topVendors = generateFilteredTopVendors(filteredSummary);
            
            // 3. DIVERSITY CHART
            chartData.diversity = generateFilteredDiversityChart(filteredSummary);
            
            // 4. DEPARTMENT CHART
            chartData.departments = generateFilteredDepartmentChart(filteredSummary);
            
            return chartData;
        }

        // Generate filtered spending trend data
        function generateFilteredSpendTrend(filteredSummary) {
            const monthlySpend = filteredSummary.total_spend;
            let labels, values;
            
            if (currentFilters.dateRange === 'last30') {
                labels = ['Week 1', 'Week 2', 'Week 3', 'Week 4'];
                values = [
                    monthlySpend * 0.28,
                    monthlySpend * 0.24,
                    monthlySpend * 0.26,
                    monthlySpend * 0.22
                ];
            } else if (currentFilters.dateRange === 'last90') {
                labels = ['Month 1', 'Month 2', 'Month 3'];
                values = [
                    monthlySpend * 0.35,
                    monthlySpend * 0.32,
                    monthlySpend * 0.33
                ];
            } else if (currentFilters.dateRange === 'ytd') {
                labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug'];
                const baseAmount = monthlySpend / 8;
                values = [
                    baseAmount * 0.8, baseAmount * 0.9, baseAmount * 1.1,
                    baseAmount * 0.95, baseAmount * 1.2, baseAmount * 0.85,
                    baseAmount * 1.15, baseAmount * 1.05
                ];
            } else {
                // For any other filter (department, diversity, amount, etc.), scale the original data
                const originalTotal = 3067695279.59; // Original total spend
                const scaleFactor = monthlySpend / originalTotal; // How much to scale down
                
                // Use the same timeline but scale all values
                labels = ['2025-01', '2025-02', '2025-03', '2025-04', '2025-05', '2025-06', '2025-07', '2025-08'];
                
                // Base monthly distribution (realistic pattern)
                const baseMonthlyValues = [
                    originalTotal * 0.08,  // Jan
                    originalTotal * 0.10,  // Feb  
                    originalTotal * 0.12,  // Mar
                    originalTotal * 0.15,  // Apr
                    originalTotal * 0.18,  // May (peak)
                    originalTotal * 0.14,  // Jun
                    originalTotal * 0.13,  // Jul
                    originalTotal * 0.10   // Aug (current month, partial)
                ];
                
                // Scale all values by the filter factor
                values = baseMonthlyValues.map(value => value * scaleFactor);
                
                // Add some realistic variation for different filter types
                if (currentFilters.department !== 'all') {
                    // Department spending might be seasonal
                    const seasonalMultipliers = [0.7, 0.8, 1.0, 1.3, 1.5, 1.2, 0.9, 0.6];
                    values = values.map((value, index) => value * seasonalMultipliers[index]);
                }
                
                if (currentFilters.diversity !== 'all') {
                    // Diversity spending might be more consistent
                    const consistentMultipliers = [0.9, 0.95, 1.0, 1.05, 1.1, 1.05, 1.0, 0.85];
                    values = values.map((value, index) => value * consistentMultipliers[index]);
                }
                
                if (currentFilters.amountRange !== 'all') {
                    // Amount-based filters might show different patterns
                    if (currentFilters.amountRange === 'over1m') {
                        // Large contracts might be quarterly
                        const quarterlyMultipliers = [1.5, 0.3, 0.2, 1.8, 0.4, 0.3, 1.2, 0.3];
                        values = values.map((value, index) => value * quarterlyMultipliers[index]);
                    } else if (currentFilters.amountRange === 'under1k') {
                        // Small purchases might be steady
                        const steadyMultipliers = [1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0];
                        values = values.map((value, index) => value * steadyMultipliers[index]);
                    }
                }
            }
            
            console.log('Generated spending trend for filters:', currentFilters);
            console.log('Total filtered spend:', monthlySpend);
            console.log('Monthly values:', values);
            
            return { labels, values };
        }

        // Generate filtered top vendors data
        function generateFilteredTopVendors(filteredSummary) {
            const totalSpend = filteredSummary.total_spend;
            let labels, values;
            
            if (currentFilters.diversity === 'minority') {
                labels = [
                    'MINORITY VENDOR A', 'MINORITY VENDOR B', 'MINORITY VENDOR C',
                    'DIVERSE CONSTRUCTION', 'COMMUNITY PARTNERS', 'LOCAL MINORITY CORP'
                ];
                values = [
                    totalSpend * 0.25, totalSpend * 0.18, totalSpend * 0.15,
                    totalSpend * 0.12, totalSpend * 0.10, totalSpend * 0.08
                ];
            } else if (currentFilters.diversity === 'woman') {
                labels = [
                    'WOMEN OWNED BUSINESS A', 'FEMALE ENTERPRISES', 'LADY CORP',
                    'SISTERHOOD SERVICES', 'WOMAN CONSTRUCTION', 'HER BUSINESS'
                ];
                values = [
                    totalSpend * 0.22, totalSpend * 0.19, totalSpend * 0.16,
                    totalSpend * 0.14, totalSpend * 0.11, totalSpend * 0.09
                ];
            } else if (currentFilters.diversity === 'veteran') {
                labels = [
                    'VETERAN SERVICES INC', 'MILITARY CONTRACTORS', 'VET CONSTRUCTION',
                    'HEROES BUSINESS', 'VETERAN SOLUTIONS', 'ARMED SERVICES CORP'
                ];
                values = [
                    totalSpend * 0.28, totalSpend * 0.21, totalSpend * 0.17,
                    totalSpend * 0.13, totalSpend * 0.12, totalSpend * 0.09
                ];
            } else if (currentFilters.department !== 'all') {
                labels = [
                    `${currentFilters.department} VENDOR A`, `${currentFilters.department} VENDOR B`,
                    `${currentFilters.department} SERVICES`, `${currentFilters.department} SOLUTIONS`,
                    `${currentFilters.department} PARTNERS`, `${currentFilters.department} CORP`
                ];
                values = [
                    totalSpend * 0.30, totalSpend * 0.22, totalSpend * 0.18,
                    totalSpend * 0.15, totalSpend * 0.10, totalSpend * 0.05
                ];
            } else {
                // Scale original vendors based on filtered amount
                const scaleFactor = totalSpend / 3067695279.59;
                labels = [
                    'GRADY CRAWFORD CONSTRUCTION CO INC', 'REPUBLIC SERVICES INC',
                    'THE WORKFORCE GROUP LLC', 'WASTE MANAGEMENT', 'WHARTON-SMITH INC', 'HARD ROCK CONSTRUCTION LLC'
                ];
                values = [
                    94097397.27 * scaleFactor, 21579107.13 * scaleFactor, 62906861.98 * scaleFactor,
                    80807831.41 * scaleFactor, 120409738.05 * scaleFactor, 55000000 * scaleFactor
                ];
            }
            
            return { labels, values };
        }

        // Generate filtered diversity chart data
        function generateFilteredDiversityChart(filteredSummary) {
            return {
                labels: ['Minority-Owned', 'Woman-Owned', 'Veteran-Owned', 'Other'],
                values: [
                    filteredSummary.diversity.minority_spend_pct,
                    filteredSummary.diversity.woman_spend_pct,
                    filteredSummary.diversity.veteran_spend_pct,
                    Math.max(0, 100 - filteredSummary.diversity.minority_spend_pct - 
                             filteredSummary.diversity.woman_spend_pct - 
                             filteredSummary.diversity.veteran_spend_pct)
                ]
            };
        }

        // Generate filtered department chart data
        function generateFilteredDepartmentChart(filteredSummary) {
            const totalSpend = filteredSummary.total_spend;
            let labels, values;
            
            if (currentFilters.department !== 'all') {
                // Single department view
                labels = [currentFilters.department];
                values = [totalSpend];
            } else if (currentFilters.diversity !== 'all') {
                // Show how diverse spending is distributed across departments
                labels = ['COMMUNITY DEVELOP', 'PUBLIC WORKS', 'AIRPORT', 'GENERAL SERVICES', 'UTILITIES'];
                values = [
                    totalSpend * 0.35, totalSpend * 0.25, totalSpend * 0.20,
                    totalSpend * 0.12, totalSpend * 0.08
                ];
            } else {
                // Scale original departments
                const scaleFactor = totalSpend / 3067695279.59;
                labels = ['COMMUNITY DEVELOP', 'PUBLIC WORKS', 'AIRPORT', 'GENERAL SERVICES', 'UTILITIES'];
                values = [
                    500000000 * scaleFactor, 800000000 * scaleFactor, 300000000 * scaleFactor,
                    400000000 * scaleFactor, 200000000 * scaleFactor
                ];
            }
            
            return { labels, values };
        }

        // Load filtered charts
        async function loadFilteredCharts(filterParams) {
            try {
                // Try to load filtered chart data
                const responses = await Promise.all([
                    fetch(`${API_URL}/charts/spend_trend?${filterParams}`),
                    fetch(`${API_URL}/charts/top_vendors?${filterParams}`),
                    fetch(`${API_URL}/charts/diversity?${filterParams}`),
                    fetch(`${API_URL}/departments?${filterParams}`)
                ]);
                
                // If any request fails, fall back to original charts
                const allSuccessful = responses.every(r => r.ok);
                if (!allSuccessful) {
                    await loadAllCharts();
                    return;
                }
                
                const [spendData, vendorData, diversityData, deptData] = await Promise.all(
                    responses.map(r => r.json())
                );
                
                updateSpendChart(spendData);
                updateVendorChart(vendorData);
                updateDiversityChart(diversityData);
                updateDepartmentChart(deptData);
                
            } catch (error) {
                console.error('Filtered charts error:', error);
                // Fallback to original charts
                await loadAllCharts();
            }
        }

        // Update active filters display
        function updateActiveFiltersDisplay() {
            const activeFiltersDiv = document.getElementById('activeFilters');
            const filterTagsDiv = document.getElementById('filterTags');
            
            const activeFilters = [];
            
            if (currentFilters.dateRange !== 'all') {
                const dateLabels = {
                    '2025': '2025',
                    '2024': '2024', 
                    'ytd': 'Year to Date',
                    'last30': 'Last 30 Days',
                    'last90': 'Last 90 Days'
                };
                activeFilters.push(`Date: ${dateLabels[currentFilters.dateRange]}`);
            }
            
            if (currentFilters.amountRange !== 'all') {
                const amountLabels = {
                    'under1k': 'Under $1K',
                    '1k-10k': '$1K - $10K',
                    '10k-100k': '$10K - $100K',
                    '100k-1m': '$100K - $1M',
                    'over1m': 'Over $1M'
                };
                activeFilters.push(`Amount: ${amountLabels[currentFilters.amountRange]}`);
            }
            
            if (currentFilters.department !== 'all') {
                activeFilters.push(`Dept: ${currentFilters.department}`);
            }
            
            if (currentFilters.diversity !== 'all') {
                const diversityLabels = {
                    'minority': 'Minority-Owned',
                    'woman': 'Woman-Owned',
                    'veteran': 'Veteran-Owned',
                    'diverse': 'Any Diverse'
                };
                activeFilters.push(`Diversity: ${diversityLabels[currentFilters.diversity]}`);
            }
            
            if (currentFilters.status !== 'all') {
                activeFilters.push(`Status: ${currentFilters.status}`);
            }
            
            if (activeFilters.length > 0) {
                filterTagsDiv.innerHTML = activeFilters.map(filter => 
                    `<span class="filter-tag">${filter}</span>`
                ).join('');
                activeFiltersDiv.style.display = 'flex';
            } else {
                activeFiltersDiv.style.display = 'none';
            }
        }

        // Load department options
        async function loadDepartmentOptions() {
            try {
                const response = await fetch(`${API_URL}/departments`);
                const data = await response.json();
                
                const departmentSelect = document.getElementById('departmentFilter');
                departmentSelect.innerHTML = '<option value="all">All Departments</option>';
                
                data.labels.slice(0, 10).forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept;
                    option.textContent = dept;
                    departmentSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading departments:', error);
            }
        }
    </script>
</body>
</html>