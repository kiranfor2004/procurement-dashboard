<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Procurement Dashboard - Drill Down Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            margin: 0;
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            overflow: hidden;
            min-height: calc(100vh - 20px);
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .back-button {
            position: absolute;
            left: 30px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .back-button:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.5);
            transform: translateY(-50%) scale(1.05);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .content {
            padding: 20px;
            max-height: calc(100vh - 160px);
            overflow-y: auto;
        }

        .drill-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .drill-title {
            font-size: 1.8em;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .drill-subtitle {
            font-size: 1.1em;
            color: #7f8c8d;
            margin-bottom: 15px;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .summary-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 15px;
            border-radius: 12px;
            border-left: 4px solid #3498db;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .summary-card h3 {
            color: #2c3e50;
            font-size: 0.8em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .summary-card .value {
            font-size: 1.5em;
            font-weight: bold;
            color: #3498db;
        }

        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
            height: 350px;
        }

        .chart-title {
            font-size: 1.2em;
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 600;
        }

        .chart-card canvas {
            max-height: 280px !important;
        }

        .data-table-container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }

        .data-table th {
            background: #f8f9fa;
            color: #2c3e50;
            padding: 12px 10px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table td {
            padding: 10px;
            border-bottom: 1px solid #dee2e6;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .amount {
            font-weight: bold;
            color: #27ae60;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #7f8c8d;
            font-size: 1.2em;
        }

        @media (max-width: 1200px) {
            .container {
                margin: 0 5px;
                border-radius: 10px;
            }
            
            .content {
                padding: 15px;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 5px;
            }
            
            .container {
                border-radius: 8px;
                min-height: calc(100vh - 10px);
            }
            
            .charts-container {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .chart-card {
                height: 300px;
                padding: 15px;
            }
            
            .chart-card canvas {
                max-height: 230px !important;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .header p {
                font-size: 1em;
            }
            
            .content {
                padding: 15px;
                max-height: calc(100vh - 140px);
            }
            
            .back-button {
                position: static;
                transform: none;
                margin-bottom: 15px;
                display: inline-block;
                padding: 8px 15px;
                font-size: 0.9em;
            }
            
            .summary-cards {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                margin-bottom: 15px;
            }
            
            .summary-card {
                padding: 12px;
            }
            
            .summary-card .value {
                font-size: 1.3em;
            }
            
            .drill-title {
                font-size: 1.5em;
            }
            
            .drill-subtitle {
                font-size: 1em;
            }
            
            .data-table {
                font-size: 0.75em;
            }
            
            .data-table th,
            .data-table td {
                padding: 8px 6px;
            }
        }

        @media (max-width: 480px) {
            .summary-cards {
                grid-template-columns: 1fr;
            }
            
            .header {
                padding: 20px 15px;
            }
            
            .content {
                padding: 10px;
            }
            
            .chart-card {
                height: 250px;
                padding: 10px;
            }
            
            .chart-card canvas {
                max-height: 180px !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="/dashboard" class="back-button">‚Üê Back to Dashboard</a>
            <h1>Drill Down Analysis</h1>
            <p>Detailed insights and data exploration</p>
        </div>

        <div class="content">
            <div class="drill-header">
                <h2 class="drill-title" id="drillTitle">Loading Analysis...</h2>
                <p class="drill-subtitle" id="drillSubtitle">Preparing detailed view</p>
            </div>

            <div class="summary-cards" id="summaryCards">
                <div class="loading">Loading summary data...</div>
            </div>

            <div class="charts-container" id="chartsContainer">
                <div class="chart-card">
                    <h3 class="chart-title">Trend Analysis</h3>
                    <canvas id="trendChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3 class="chart-title">Distribution Breakdown</h3>
                    <canvas id="distributionChart"></canvas>
                </div>
            </div>

            <div class="data-table-container">
                <h3 class="chart-title">Detailed Records</h3>
                <div style="overflow-x: auto;">
                    <table class="data-table" id="detailTable">
                        <thead>
                            <tr>
                                <th>Vendor</th>
                                <th>Department</th>
                                <th>Amount</th>
                                <th>Date</th>
                                <th>Category</th>
                                <th>Status</th>
                                <th>Diversity</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 30px;">Loading data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables for charts
        let trendChart = null;
        let distributionChart = null;

        // API Base URL - detect if running on GitHub Pages
        const isGitHubPages = window.location.hostname.includes('github.io');
        const API_BASE = (() => {
            const hostname = window.location.hostname;
            
            // Production Azure detection
            if (hostname.includes('azurewebsites.net')) {
                return window.location.origin;  // Azure production
            }
            
            // Local development
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                return 'http://localhost:5001';
            }
            
            // GitHub Pages or other static hosting
            if (hostname.includes('github.io') || hostname.includes('netlify') || hostname.includes('vercel')) {
                return '';  // Will use demo mode
            }
            
            // Default to current origin for other deployments
            return window.location.origin;
        })();

        // Function to get URL parameters
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            const results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        // Function to format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        }

        // Function to load drill-down data
        async function loadDrillDownData() {
            try {
                const type = getUrlParameter('type');
                const value = getUrlParameter('value');
                const filter = getUrlParameter('filter');

                console.log('Drill-down parameters:', { type, value, filter });

                // Update page title and subtitle
                updatePageHeader(type, value);

                if (isGitHubPages) {
                    // Load demo data for GitHub Pages
                    loadDemoData(type, value);
                } else {
                    // Load real data from API
                    await loadRealData(type, value, filter);
                }
            } catch (error) {
                console.error('Error loading drill-down data:', error);
                document.getElementById('summaryCards').innerHTML = 
                    '<div class="loading">Error loading data. Please try again.</div>';
            }
        }

        // Function to update page header
        function updatePageHeader(type, value) {
            const title = document.getElementById('drillTitle');
            const subtitle = document.getElementById('drillSubtitle');

            switch(type) {
                case 'total_spend':
                    title.textContent = 'Total Spending Analysis';
                    subtitle.textContent = 'Detailed breakdown of procurement expenditure';
                    break;
                case 'vendor_count':
                    title.textContent = 'Vendor Analysis';
                    subtitle.textContent = 'Comprehensive vendor performance metrics';
                    break;
                case 'department':
                    title.textContent = `${value} Department Analysis`;
                    subtitle.textContent = 'Department-specific procurement insights';
                    break;
                case 'diversity':
                    title.textContent = 'Diversity Spending Analysis';
                    subtitle.textContent = 'Breakdown of diversity vendor procurement';
                    break;
                default:
                    title.textContent = 'Detailed Analysis';
                    subtitle.textContent = 'Comprehensive procurement insights';
            }
        }

        // Function to load demo data for GitHub Pages
        function loadDemoData(type, value) {
            // Sample data for demonstration
            const demoData = {
                summary: {
                    totalAmount: 487500,
                    recordCount: 20,
                    avgAmount: 24375,
                    topVendor: 'Construction Co'
                },
                trendData: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug'],
                    data: [45000, 52000, 68000, 61000, 58000, 75000, 82000, 89000]
                },
                distributionData: {
                    labels: ['IT', 'Facilities', 'HR', 'Admin', 'Finance'],
                    data: [156000, 151000, 85500, 45700, 49300]
                },
                records: [
                    { vendor: 'Construction Co', department: 'Facilities', amount: 75000, date: '2024-06-01', category: 'Construction', status: 'Completed', diversity: 'Non-Diverse' },
                    { vendor: 'Research Lab', department: 'R&D', amount: 65000, date: '2024-08-28', category: 'Research', status: 'Completed', diversity: 'Diverse' },
                    { vendor: 'Consulting Group', department: 'Strategy', amount: 45000, date: '2024-06-20', category: 'Consulting', status: 'Completed', diversity: 'Diverse' },
                    { vendor: 'Software Vendor', department: 'IT', amount: 42000, date: '2024-08-29', category: 'Software', status: 'Pending', diversity: 'Non-Diverse' },
                    { vendor: 'Data Analytics', department: 'IT', amount: 35000, date: '2024-04-01', category: 'Software', status: 'Completed', diversity: 'Diverse' }
                ]
            };

            displayData(demoData);
        }

        // Function to load real data from API
        async function loadRealData(type, value, filter) {
            try {
                let url = `${API_BASE}/api/drill-down?type=${type}`;
                if (value) url += `&value=${encodeURIComponent(value)}`;
                if (filter) url += `&filter=${encodeURIComponent(filter)}`;

                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                displayData(data);
            } catch (error) {
                console.error('API Error:', error);
                // Fallback to demo data if API fails
                loadDemoData(type, value);
            }
        }

        // Function to display the loaded data
        function displayData(data) {
            // Update summary cards
            const summaryHtml = `
                <div class="summary-card">
                    <h3>Total Amount</h3>
                    <div class="value">${formatCurrency(data.summary.totalAmount)}</div>
                </div>
                <div class="summary-card">
                    <h3>Record Count</h3>
                    <div class="value">${data.summary.recordCount.toLocaleString()}</div>
                </div>
                <div class="summary-card">
                    <h3>Average Amount</h3>
                    <div class="value">${formatCurrency(data.summary.avgAmount)}</div>
                </div>
                <div class="summary-card">
                    <h3>Top Vendor</h3>
                    <div class="value" style="font-size: 1.2em;">${data.summary.topVendor}</div>
                </div>
            `;
            document.getElementById('summaryCards').innerHTML = summaryHtml;

            // Create trend chart
            createTrendChart(data.trendData);

            // Create distribution chart
            createDistributionChart(data.distributionData);

            // Update data table
            updateDataTable(data.records);
        }

        // Function to create trend chart
        function createTrendChart(trendData) {
            const ctx = document.getElementById('trendChart').getContext('2d');
            
            if (trendChart) {
                trendChart.destroy();
            }

            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: trendData.labels,
                    datasets: [{
                        label: 'Spending Trend',
                        data: trendData.data,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Function to create distribution chart
        function createDistributionChart(distributionData) {
            const ctx = document.getElementById('distributionChart').getContext('2d');
            
            if (distributionChart) {
                distributionChart.destroy();
            }

            distributionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: distributionData.labels,
                    datasets: [{
                        data: distributionData.data,
                        backgroundColor: [
                            '#3498db',
                            '#e74c3c',
                            '#2ecc71',
                            '#f39c12',
                            '#9b59b6'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                usePointStyle: true,
                                font: {
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });
        }

        // Function to update data table
        function updateDataTable(records) {
            const tbody = document.getElementById('tableBody');
            const html = records.map(record => `
                <tr>
                    <td>${record.vendor}</td>
                    <td>${record.department}</td>
                    <td class="amount">${formatCurrency(record.amount)}</td>
                    <td>${record.date}</td>
                    <td>${record.category}</td>
                    <td><span class="status-${record.status.toLowerCase()}">${record.status}</span></td>
                    <td>${record.diversity}</td>
                </tr>
            `).join('');
            
            tbody.innerHTML = html;
        }

        // Initialize the page when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            loadDrillDownData();
        });

        // Handle chart canvas sizing
        window.addEventListener('resize', function() {
            if (trendChart) trendChart.resize();
            if (distributionChart) distributionChart.resize();
        });
    </script>
</body>
</html>
